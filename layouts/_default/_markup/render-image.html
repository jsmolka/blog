{{ $src := "" }}
{{ $cap := .Title | $.Page.RenderString }}
{{ $alt := .Text | default $cap | plainify }}
{{ $img := .Page.Resources.GetMatch .Destination }}
{{ with $img }}
  {{ $src = .RelPermalink }}
{{ else }}
  {{ $src = .Destination | relURL }}
  {{ $img = imageConfig (path.Join "static" .Destination) }}
{{ end }}
<figure>
  {{ $hash := "" }}
  {{ if hugo.IsProduction }}
    {{ $hash = printf "?v=%s" ($img.Content | md5) }}
  {{ end }}
  <img src="{{ $src }}{{ $hash }}" alt="{{ $alt }}" width="{{ $img.Width }}" height="{{ $img.Height }}" loading="lazy">
  {{ with $cap }}
    <figcaption>{{ . }}</figcaption>
  {{ end }}
</figure>
