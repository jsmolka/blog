---
title: "WebAssembly Port"
author: "Julian Smolka"
summary: "WebAssembly port of the eggvance GBA emulator."
date: 2020-04-12
type: blank
---
<div x-data="{ controls: false }" class="base flex flex-col w-full max-w-screen-xl m-auto p-4 items-center">
  <canvas id="canvas" class="w-full bg-dark-900"></canvas>
  <input id="rom-input" class="hidden" type="file" accept=".gba" onchange="Module.loadRom()">
  <input id="save-input" class="hidden" type="file" accept=".sav" onchange="Module.loadSave()">
  <div class="flex mt-4">
    <button class="mr-4" onclick="inputRom.click()">Load rom</button>
    <button class="mr-4" onclick="inputSave.click()">Load save</button>
    <button class="mr-4" onclick="Module.loadDemo()">Load demo</button>
    <button @click="controls = !controls" x-text="`${controls ? 'Hide' : 'Show'} controls`"/>
  </div>
  <div class="w-full max-w-screen-md mt-4" :class="{ hidden: !controls }">
  {{<markdown>}}
  | Emulator     | Keyboard | Controller |
  |--------------|----------|------------|
  | Up           | W        | Up         |
  | Down         | S        | Down       |
  | Left         | A        | Left       |
  | Right        | D        | Right      |
  | A            | U        | B          |
  | B            | H        | A          |
  | Start        | G        | Start      |
  | Select       | F        | Back       |
  | L            | Q        | L          |
  | R            | I        | R          |
  | Reset        | R        | -          |
  | Change speed | 1 to 6   | -          |
  {{</markdown>}}
  </div>
</div>
<script type='text/javascript'>
  const inputRom  = document.getElementById('rom-input');
  const inputSave = document.getElementById('save-input');

  class FileSystem {
    constructor() {
      this.id = 0;
    }

    write(data) {
      const filename = `data${this.id++}.bin`;
      FS.writeFile(filename, data);

      return filename;
    }
  }

  var Module = {
    fs: new FileSystem(),
    canvas: document.getElementById('canvas'),
    onRuntimeInitialized() {
      FS.writeFile('eggvance.toml', `
        [general]
        save_path = ""
        bios_file = ""
        bios_skip = true

        [cartridge]
        save_type = "auto"
        gpio_type = "auto"

        [framerate]
        custom_1 = 119.474
        custom_2 = 238.948
        custom_3 = 358.442
        custom_4 = 477.896

        [controls]
        a      = ["U", "B"    ]
        b      = ["H", "A"    ]
        up     = ["W", "Up"   ]
        down   = ["S", "Down" ]
        left   = ["A", "Left" ]
        right  = ["D", "Right"]
        start  = ["G", "Start"]
        select = ["F", "Back" ]
        l      = ["Q", "L"    ]
        r      = ["I", "R"    ]

        [shortcuts]
        reset       = ["R", ""]
        fullscreen  = ["T", ""]
        fr_hardware = ["1", ""]
        fr_custom_1 = ["2", ""]
        fr_custom_2 = ["3", ""]
        fr_custom_3 = ["4", ""]
        fr_custom_4 = ["5", ""]
        fr_unbound  = ["6", ""]
      `);

      this.eggvanceSetBackground(0xFF161823);
    },
    async readUrl(url) {
      return new Promise(resolve => {
        const request = new XMLHttpRequest();

        request.open('GET', url);
        request.responseType = 'arraybuffer';
        request.onload = event => {
          resolve(new Uint8Array(request.response));
        }
        request.send();
      });
    },
    async readFile(input) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve(new Uint8Array(reader.result));
        }
        reader.readAsArrayBuffer(input.files[0]);
        input.value = '';
      });
    },
    async loadRom() {
      const data = await this.readFile(inputRom);
      this.eggvanceLoadRom(this.fs.write(data));
    },
    async loadDemo() {
      const data = await this.readUrl('/roms/bigmap.gba');
      this.eggvanceLoadRom(this.fs.write(data));
    },
    async loadSave() {
      const data = await this.readFile(inputSave);
      this.eggvanceLoadSave(this.fs.write(data));
    }
  };

  window.onload = () => {
    const canvas = document.getElementById('canvas');
    const width  = canvas.clientWidth;
    const height = 2 * width / 3;

    const style = document.createElement('style');
    style.appendChild(document.createTextNode(`#canvas { width: ${width}px; height: ${height}px }`));
    document.head.appendChild(style);

    window.onresize = () => {
      style.remove();
      canvas.height = 2 * canvas.width / 3;
    }
  }
</script>
<script async src=/wasm/eggvance.js></script>
